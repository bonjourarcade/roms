<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BonjourArcade</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Play now!">
    <meta property="og:description" content="Play now!">
    <meta property="og:image" content="">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Play now!">
    <meta property="twitter:description" content="Play now!">
    <meta property="twitter:image" content="">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        /* Reset all elements to prevent overflow */
        * {
            box-sizing: border-box !important;
        }
        
        /* Basic styling to make the emulator fill the page */
        html, body { 
            margin: 0 !important; 
            padding: 0 !important; 
            height: 100% !important; 
            width: 100% !important;
            overflow: hidden !important; 
            background-color: #000 !important; 
            color: #eee !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }
        #game-container { 
            width: 100% !important; 
            height: 100% !important; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin: 0 !important;
            padding: 0 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            padding-bottom: env(safe-area-inset-bottom, 16px);
        }
        #game { 
            width: 100% !important; 
            height: 100% !important; 
            margin: 0 !important;
            padding: 0 !important;
        }
        .error-message { font-family: sans-serif; padding: 20px; text-align: center; color: #ffdddd; background-color: #330000; border: 1px solid red;}
        /* Styling for QR code */
        #qr-code-container {
            position: fixed !important;
            top: 60px !important;
            right: 10px !important;
            background-color: white;
            padding: 8px !important;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2000; /* Raised above banner */
            display: none; /* Hidden by default, will be shown by JS */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer; /* Indicate it's clickable */
            margin: 0 !important;
        }
        #qr-code-container p {
            font-family: sans-serif;
            font-size: 14px;
            color: #333;
            margin-top: 5px;
            margin-bottom: 0;
            text-align: center;
        }
        
        /* Help button styling */
        #help-button {
            position: fixed !important;
            top: 10px !important;
            right: 10px !important;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px !important;
            border-radius: 8px;
            cursor: pointer;
            display: none; /* Hidden by default, will be shown by JS on desktop only */
            align-items: center;
            gap: 6px;
            font-family: sans-serif;
            font-size: 12px !important;
            z-index: 1999;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.2s;
            margin: 0 !important;
            backdrop-filter: blur(10px);
        }
        #help-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }
        
        /* Help modal styling */
        #help-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        #help-modal-content {
            background-color: #1a1a1a;
            border-radius: 12px;
            padding: 15px;
            max-width: 98%;
            max-height: 98%;
            overflow: auto;
            position: relative;
            border: 2px solid #333;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            /* Ensure proper height constraints for responsive image scaling */
            min-height: 0;
        }
        
        #help-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        #help-modal-content h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #ffd700;
            padding-right: 30px;
            flex-shrink: 0;
        }
        
        #help-modal-content img {
            max-width: 100%;
            max-height: calc(100% - 50px); /* Account for title and padding */
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            /* Ensure image scales down when window height is reduced */
            min-height: 0;
            flex-shrink: 1;
            /* Force height to be responsive to container */
            height: 100%;
        }
        
        /* Leaderboard styling */
        #leaderboard-container {
            position: fixed !important;
            top: 190px !important;
            right: 10px !important;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px !important;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1999;
            display: none; /* Hidden by default, will be shown by JS */
            flex-direction: column;
            max-width: 200px;
            max-height: 350px;
            overflow-y: auto;
            font-family: sans-serif;
            font-size: 11px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Mobile leaderboard popup styling */
        #mobile-leaderboard-popup {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        #mobile-leaderboard-content {
            background-color: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            border: 2px solid #333;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        #mobile-leaderboard-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        #mobile-leaderboard-content h3 {
            margin: 0 0 20px 0;
            font-size: 18px;
            text-align: center;
            color: #ffd700;
            padding-right: 30px;
        }
        
        .mobile-leaderboard-entry {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 8px;
            background-color: #333;
            border-radius: 6px;
        }
        
        .mobile-leaderboard-rank {
            font-size: 20px;
            margin-right: 15px;
            min-width: 30px;
        }
        
        .mobile-leaderboard-player {
            flex: 1;
            font-size: 16px;
            color: #fff;
        }
        
        .mobile-leaderboard-score {
            font-size: 16px;
            color: #ffd700;
            font-weight: bold;
        }
        #leaderboard-container h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            text-align: center;
            color: #ffd700;
        }
        .leaderboard-entry {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            padding: 3px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .leaderboard-rank {
            font-weight: bold;
            color: #ffd700;
            margin-right: 6px;
            min-width: 16px;
            flex-shrink: 0;
        }
        .leaderboard-player {
            flex: 1;
            margin-right: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }
        .leaderboard-score {
            font-weight: bold;
            color: #00ff00;
        }
        .leaderboard-loading {
            text-align: center;
            color: #ccc;
            font-style: italic;
        }
        .leaderboard-error {
            text-align: center;
            color: #ff6b6b;
            font-style: italic;
        }
        /* Menu button styling */
        #menu-button {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px !important;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: sans-serif;
            font-size: 12px !important;
            z-index: 2000; /* Raised above banner */
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.2s;
            margin: 0 !important;
        }
        #menu-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }
        #menu-button .arrow {
            font-size: 18px;
        }
        
        /* Mouse auto-hide functionality */
        body.mouse-hidden {
            cursor: none !important;
        }
        
        body.mouse-hidden * {
            cursor: none !important;
        }
    </style>
</head>
<body>
    <!-- Menu Button -->
    <div id="menu-button">
        <span class="arrow">‚Üê</span>
        <span>MENU</span>
    </div>
    <!-- Controls Overlay (desktop only) -->
    <div id="controls-overlay" style="display:none;position:fixed;top:52px;left:10px;z-index:1999;background:rgba(0,0,0,0.85);color:#fff;padding:8px 14px 8px 12px;border-radius:6px;font-size:18px;font-family:sans-serif;box-shadow:0 2px 8px #0005;min-width:40px;max-width:220px;line-height:1.5;pointer-events:none;"></div>

    <div id="game-container">
        <div id="game"><p style="text-align: center; padding-top: 50px;">Initializing...</p></div>
    </div>

    <!-- QR Code Container -->
    <div id="qr-code-container">
        <div id="qr-code"></div>
        <p>Partage ton score !</p>
    </div>

    <!-- Help Button -->
    <button id="help-button">
        <span>‚ùî</span>
        <span>Aide</span>
    </button>

    <!-- Help Modal -->
    <div id="help-modal">
        <div id="help-modal-content">
            <button id="help-modal-close">√ó</button>
            <h3>Guide d'utilisation</h3>
            <img src="../assets/images/getting-started.png" alt="Guide d'utilisation">
        </div>
    </div>

    <!-- Leaderboard Container -->
    <div id="leaderboard-container">
        <h3>üèÜ Meilleurs Scores</h3>
        <div id="leaderboard-content">
            <div class="leaderboard-loading">Chargement...</div>
        </div>
    </div>
    
    <!-- Mobile Leaderboard Popup -->
    <div id="mobile-leaderboard-popup">
        <div id="mobile-leaderboard-content">
            <button id="mobile-leaderboard-close">√ó</button>
            <h3>üèÜ Meilleurs Scores</h3>
            <div id="mobile-leaderboard-content-data">
                <div class="leaderboard-loading">Chargement...</div>
            </div>
        </div>
    </div>

    <script src="../assets/js/banner.js"></script>
    <script src="../assets/js/game-history.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function basename(path) {
            return path.split('/').pop().split('\\').pop();
        }

        // Custom buttons
        window.EJS_Buttons = {
          playPause: true,
          restart: true,
          mute: true,
          settings: true,
          fullscreen: true,
          saveState: true,
          loadState: true,
          screenRecord: true,
          gamepad: true,
          cheat: false,
          volume: true,
          saveSavFiles: false,
          loadSavFiles: false,
          quickSave: true,
          quickLoad: true,
          screenshot: true,
          cacheManager: true,
          customDownload: {
              visible: true,
              displayName: "Download this game",
              icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/><path d="M12,19L16,15H13V11H11V15H8L12,19Z"/></svg>',
              callback: () => {
                  downloadFile(window.EJS_gameUrl,
                    basename(window.EJS_gameUrl));
              }
          },
          exitEmulation: false
        };



        // Function to detect if the device is mobile
        function isMobileDevice() {
            return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        /**
         * Helper function to update meta tags
         * @param {string} property - The meta tag property to update
         * @param {string} content - The new content value
         */
        function updateMetaTag(property, content) {
            const metaTag = document.querySelector(`meta[property="${property}"]`) || 
                           document.querySelector(`meta[name="${property}"]`);
            if (metaTag) {
                metaTag.setAttribute('content', content);
            }
        }
        // Summarize controls (same logic as main menu/newsletter)
        function summarizeControls(controls) {
            if (!controls || !Array.isArray(controls)) return '';
            const joystickLines = controls.filter(line => String(line).trim().startsWith('üïπÔ∏è'));
            if (joystickLines.length >= 2) return 'üïπÔ∏èüïπÔ∏è';
            let summary = '';
            for (let line of controls) {
                line = String(line).trim();
                if (!line) continue;
                let first = line.split(' ')[0];
                if ([
                    '1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','0Ô∏è‚É£'
                ].includes(first)) {
                    first = 'üî¥';
                }
                summary += first + ' ';
            }
            return summary.trim();
        }

        // --- Logic for the Single Game Launcher Page (using JSON Controls) ---

        /**
         * Displays an error message within the game container.
         * @param {string} message - The error message to display.
         */
        function showLauncherError(message) {
            const gameContainer = document.getElementById('game-container');
            if (gameContainer) {
                // Display the error message inside the main container
                gameContainer.innerHTML = `<p class="error-message">Error: ${message}</p>`;
            }
            // Also set a generic error title for the page tab
            document.title = "Error Loading Game";
        }

        /**
         * Main async function to:
         * 1. Get game ID from URL.
         * 2. Fetch game list data.
         * 3. Find the specific game's details.
         * 4. Fetch emulator settings.
         * 5. Fetch game controls (from JSON).
         * 6. Set up EmulatorJS variables.
         * 7. Load the EmulatorJS engine.
         */
        async function loadSelectedGame() {
            // Step 1: Get Game ID from URL parameter (?game=...)
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');

            if (!gameId) {
                window.location.href = "../";
            }
            console.log(`Attempting to load game with ID: ${gameId}`);

            // QR Code generation logic
            const qrCodeContainer = document.getElementById('qr-code-container');
            const leaderboardUrl = `https://alloarcade.web.app/leaderboards/verify/${gameId}`;

            if (qrCodeContainer) {
                if (!isMobileDevice()) {
                    qrCodeContainer.style.display = 'flex'; // Show container for desktop
                    new QRCode(document.getElementById("qr-code"), {
                        text: leaderboardUrl,
                        width: 90,
                        height: 90,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                    // Make the container clickable for desktop
                    qrCodeContainer.addEventListener('click', () => {
                        window.open(leaderboardUrl, '_blank');
                    });
                } else {
                    // On mobile, hide the entire container
                    qrCodeContainer.style.display = 'none';
                }
            }

            // Leaderboard fetching logic
            async function fetchLeaderboard(gameId) {
                const leaderboardContainer = document.getElementById('leaderboard-container');
                const leaderboardContent = document.getElementById('leaderboard-content');
                
                if (!leaderboardContainer || !leaderboardContent) return;

                // Show loading state
                leaderboardContent.innerHTML = '<div class="leaderboard-loading">Chargement...</div>';
                
                try {
                    // Check if we're on localhost and use mock data
                    const isLocalhost = window.location.hostname === 'localhost' || 
                                      window.location.hostname === '127.0.0.1' || 
                                      window.location.hostname.includes('localhost');
                    
                    let data;
                    
                    if (isLocalhost) {
                        // Use mock data for localhost
                        console.log('Using mock leaderboard data for localhost');
                        data = {
                            result: {
                                success: true,
                                scores: generateMockScores(gameId)
                            }
                        };
                    } else {
                        // Use real API for production
                        const response = await fetch('https://us-central1-alloarcade.cloudfunctions.net/listGameScores', {
                            method: 'POST',
                            headers: {
                                'accept': '*/*',
                                'accept-language': 'en-CA,en;q=0.9,fr-CA;q=0.8,fr;q=0.7,en-GB;q=0.6,en-US;q=0.5',
                                'cache-control': 'no-cache',
                                'content-type': 'application/json',
                                'firebase-instance-id-token': 'd81DC0UGvyC6i41_okOipa:APA91bHNG-8qmIvzgyCLGKg54RBFwRyB2hx6QEcZ2BJUHcbmcvilEJnpCQscmrnOgpVrFlurW4Fg6b0Lkzs_Lzgl53iECK6E8-pPLVN_yHC8_beMww7Blxg',
                                'origin': 'https://alloarcade.web.app',
                                'pragma': 'no-cache',
                                'priority': 'u=1, i',
                                'referer': 'https://alloarcade.web.app/',
                                'sec-ch-ua': '"Not)A;Brand";v="8", "Chromium";v="138", "Google Chrome";v="138"',
                                'sec-ch-ua-mobile': '?0',
                                'sec-ch-ua-platform': '"Windows"',
                                'sec-fetch-dest': 'empty',
                                'sec-fetch-mode': 'cors',
                                'sec-fetch-site': 'cross-site',
                                'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'
                            },
                            body: JSON.stringify({
                                data: {
                                    timeRange: "all",
                                    gameId: gameId
                                }
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        data = await response.json();
                    }
                    
                    if (!data.result || !data.result.success || !data.result.scores) {
                        throw new Error('Invalid response format');
                    }

                    // Get best score for each unique player
                    const playerBestScores = new Map();
                    
                    data.result.scores.forEach(score => {
                        const userId = score.userId;
                        const currentBest = playerBestScores.get(userId);
                        
                        if (!currentBest || score.score > currentBest.score) {
                            playerBestScores.set(userId, {
                                player: score.player,
                                score: score.score,
                                rank: score.rank
                            });
                        }
                    });

                    // Convert to array and sort by score (highest first)
                    const sortedScores = Array.from(playerBestScores.values())
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 10); // Show top 10 players

                    if (sortedScores.length === 0) {
                        leaderboardContent.innerHTML = '<div class="leaderboard-loading">Aucun score trouv√©</div>';
                        return;
                    }

                    // Build leaderboard HTML
                    let leaderboardHTML = '';
                    sortedScores.forEach((score, index) => {
                        const rank = index + 1;
                        const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                        
                        leaderboardHTML += `
                            <div class="leaderboard-entry">
                                <div class="leaderboard-rank">${rankEmoji}</div>
                                <div class="leaderboard-player">${score.player}</div>
                                <div class="leaderboard-score">${score.score.toLocaleString()}</div>
                            </div>
                        `;
                    });

                    leaderboardContent.innerHTML = leaderboardHTML;
                    
                    // Show leaderboard container on desktop, popup on mobile (but not in screensaver mode)
                    if (!isMobileDevice()) {
                        leaderboardContainer.style.display = 'flex';
                    } else {
                        // Check if we're in screensaver mode - don't show popup if we are
                        const isScreensaverMode = sessionStorage.getItem('screensaverMode') === 'true';
                        if (!isScreensaverMode) {
                            // Show mobile popup
                            const mobilePopup = document.getElementById('mobile-leaderboard-popup');
                            const mobileContent = document.getElementById('mobile-leaderboard-content-data');
                            if (mobilePopup && mobileContent) {
                                // Build mobile leaderboard HTML
                                let mobileLeaderboardHTML = '';
                                sortedScores.forEach((score, index) => {
                                    const rank = index + 1;
                                    const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                                    
                                    mobileLeaderboardHTML += `
                                        <div class="mobile-leaderboard-entry">
                                            <div class="mobile-leaderboard-rank">${rankEmoji}</div>
                                            <div class="mobile-leaderboard-player">${score.player}</div>
                                            <div class="mobile-leaderboard-score">${score.score.toLocaleString()}</div>
                                        </div>
                                    `;
                                });
                                mobileContent.innerHTML = mobileLeaderboardHTML;
                                mobilePopup.style.display = 'flex';
                            }
                        }
                    }

                } catch (error) {
                    console.error('Error fetching leaderboard:', error);
                    leaderboardContent.innerHTML = '<div class="leaderboard-error">Erreur de chargement</div>';
                }
            }

            // Mock data generator function
            function generateMockScores(gameId) {
                const mockPlayers = [
                    { name: "F√©lix L", userId: "user1" },
                    { name: "Marie C", userId: "user2" },
                    { name: "Jean P", userId: "user3" },
                    { name: "Sophie M", userId: "user4" },
                    { name: "Pierre D", userId: "user5" },
                    { name: "Alice R", userId: "user6" },
                    { name: "Thomas B", userId: "user7" },
                    { name: "Emma L", userId: "user8" }
                ];

                // Generate different score ranges based on game type
                let baseScore = 1000;
                if (gameId.includes('shmup') || gameId.includes('shoot')) {
                    baseScore = 50000;
                } else if (gameId.includes('puzzle')) {
                    baseScore = 5000;
                } else if (gameId.includes('platform')) {
                    baseScore = 15000;
                }

                return mockPlayers.map((player, index) => ({
                    rank: index + 1,
                    id: `mock_${player.userId}_${Date.now()}`,
                    userId: player.userId,
                    player: player.name,
                    photoURL: `https://via.placeholder.com/96/cccccc/666666?text=${player.name.charAt(0)}`,
                    score: Math.floor(baseScore * (1 + Math.random() * 5) * (1 - index * 0.1)),
                    game: gameId,
                    date: {
                        _seconds: Math.floor(Date.now() / 1000) - Math.floor(Math.random() * 86400 * 30), // Random date within last 30 days
                        _nanoseconds: Math.floor(Math.random() * 1000000000)
                    },
                    verified: true,
                    screenshotUrl: `https://via.placeholder.com/300x200/333333/ffffff?text=Screenshot`
                }));
            }

            // Fetch leaderboard data
            fetchLeaderboard(gameId);
            
            // Set up periodic refresh of leaderboard every 10 minutes
            const scoreRefreshInterval = setInterval(() => {
                console.log('Refreshing leaderboard scores (10-minute interval)');
                fetchLeaderboard(gameId);
            }, 600000); // 10 minutes = 600,000 milliseconds
            
            // Store interval ID for cleanup if needed
            window.leaderboardRefreshInterval = scoreRefreshInterval;

            try {
                // Step 2: Fetch the master game list
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const cacheBuster = '?v=' + Date.now();
                const gamelistUrl = isLocalhost ? '../gamelist.json' + cacheBuster : 'https://storage.googleapis.com/bonjourarcade/gamelist.json' + cacheBuster;
                const listResponse = await fetch(gamelistUrl);
                if (!listResponse.ok) {
                    throw new Error(`Failed to fetch game list '/gamelist.json' (Status: ${listResponse.status})`);
                }
                const gameData = await listResponse.json();

                // Step 3: Find the specific game data using the gameId
                console.log(`Searching for game ID '${gameId}' in game list...`);
                let selectedGame = null;
                if (Array.isArray(gameData.games)) {
                    selectedGame = gameData.games.find(game => game.id === gameId);
                }

                // Handle case where the game is not found in the list
                if (!selectedGame) {
                    throw new Error(`Game with ID '${gameId}' not found in game list.`);
                }
                console.log("Found game data:", selectedGame);

                // --- Hide leaderboard button if enable_score is explicitly false ---
                if (selectedGame.enable_score === false || selectedGame.enable_score === "false") {
                    const qrCodeContainer = document.getElementById('qr-code-container');
                    const leaderboardContainer = document.getElementById('leaderboard-container');
                    const helpButton = document.getElementById('help-button');
                    if (qrCodeContainer) qrCodeContainer.style.display = 'none';
                    if (leaderboardContainer) leaderboardContainer.style.display = 'none';
                    if (helpButton) helpButton.style.display = 'none';
                }
                
                // --- Show help button on desktop (both normal and screensaver mode) ---
                const helpButton = document.getElementById('help-button');
                if (helpButton) {
                    const isMobile = isMobileDevice();
                    if (isMobile) {
                        helpButton.style.display = 'none';
                    } else {
                        helpButton.style.display = 'flex';
                    }
                }

                // Step 4: Check if the ROM or Core info for this game is missing
                if (selectedGame.romMissing === true || !selectedGame.romPath || !selectedGame.core || selectedGame.core === 'null') {
                     throw new Error(`Required files (ROM or Core info) for game '${selectedGame.title || gameId}' are missing according to gamelist.json.`);
                }

                // Step 5.5: Update meta tags for proper link previews
                const gameTitle = selectedGame.title || gameId;
                // Update page title to game's full title
                document.title = gameTitle;
                
                // Update page title and meta tags
                updateMetaTag('og:title', `Play now! ${gameTitle}`);
                updateMetaTag('twitter:title', `Play now! ${gameTitle}`);
                
                // Update image to use relative path
                if (selectedGame.coverArt) {
                    updateMetaTag('og:image', selectedGame.coverArt);
                    updateMetaTag('twitter:image', selectedGame.coverArt);
                }
                // Show controls overlay (desktop only)
                const controlsOverlay = document.getElementById('controls-overlay');
                if (controlsOverlay) {
                    if (!isMobileDevice() && selectedGame.controls && Array.isArray(selectedGame.controls) && selectedGame.controls.length > 0) {
                        // Build overlay HTML: 'Controls' on first line, then each control line
                        let html = '<div style="font-weight:bold;font-size:15px;margin-bottom:2px;">Contr√¥les</div>';
                        html += selectedGame.controls.map(line => `<div>${line}</div>`).join('');
                        if (selectedGame.to_start) {
                            // Replace '->' with a better looking right arrow
                            let toStartDisplay = selectedGame.to_start.replace(/->/g, '‚Üí');
                          html += '<div style="margin-top:10px;font-size:15px;"><span style="font-weight:bold;">Pour commencer:</span><br>' + toStartDisplay + '</div>';
                        }
                        controlsOverlay.innerHTML = html;
                        controlsOverlay.style.display = 'block';
                    } else {
                        controlsOverlay.style.display = 'none';
                    }
                }

                // Step 6: Set the Core EJS Variables Globally (used by EmulatorJS loader)
                console.log(`Setting EJS Vars - Core: ${selectedGame.core}, ROM: ${selectedGame.romPath}`);
                window.EJS_player = "#game";        // Emulator renders in the #game div
                window.EJS_core = selectedGame.core;    // Core name from gamelist.json
                window.EJS_gameUrl = selectedGame.romPath; // ROM path from gamelist.json
                window.EJS_loadStateURL = selectedGame.saveState !== '' ? selectedGame.saveState : undefined;

                // Step 7: Fetch General Emulator Settings
                console.log("Fetching emulator settings: /config/emulator_settings.json");
                const settingsResponse = await fetch('/config/emulator_settings.json'); // Absolute path
                if (!settingsResponse.ok) throw new Error(`Failed to load '/config/emulator_settings.json' (Status: ${settingsResponse.status})`);
                const settings = await settingsResponse.json();
                if (!settings) throw new Error("Emulator settings file loaded but contained invalid data.");

                // Step 8: Assign Fetched Settings Globally
                for (const [key, value] of Object.entries(settings)) {
                  window[`${key}`] = value;
                }

                // --- NEW: Attempt to load game-specific config.json ---
                try {
                  const gameConfigPath = `/games/${gameId}/config.json`;
                  console.log(`Attempting to fetch game-specific config: ${gameConfigPath}`);
                  const gameConfigResponse = await fetch(gameConfigPath);
                  if (gameConfigResponse.ok) {
                    const gameConfig = await gameConfigResponse.json();
                    if (!gameConfig || typeof gameConfig !== 'object') {
                      throw new Error(`Game config file '${gameConfigPath}' loaded but contained invalid JSON.`);
                    }
                    
                    // Log the game-specific config values
                    console.log(`Game-specific config values for ${gameId}:`);
                    for (const [key, value] of Object.entries(gameConfig)) {
                      console.log(`  ${key} = ${value}`);
                    }
                    
                    // Merge/override global settings with game-specific settings
                    for (const [key, value] of Object.entries(gameConfig)) {
                      window[`${key}`] = value;
                    }
                    console.log(`Game-specific config loaded and merged for: ${gameId}`);
                  } else if (gameConfigResponse.status !== 404) {
                    throw new Error(`Failed to load game config '${gameConfigPath}' (Status: ${gameConfigResponse.status})`);
                  } else {
                    console.log(`No game-specific config found for: ${gameId}`);
                  }
                } catch (gameConfigError) {
                  console.error(`Error loading or parsing game-specific config:`, gameConfigError);
                  showLauncherError(gameConfigError.message || `An error occurred loading game-specific config.`);
                  return;
                }

                console.log("Final merged emulator settings (global + game-specific):");
                // Log all EJS_* variables that are set
                for (const key of Object.keys(window)) {
                  if (key.startsWith('EJS_')) {
                    console.log(`  ${key} = ${window[key]}`);
                  }
                }

                window.EJS_backgroundImage =
                `${window.location.protocol}//${window.location.hostname}:${window.location.port}/games/${gameId}/cover.png`; // Set background to game's cover

                // Step 9: Fetch Controls JSON based on Core
                const coreName = window.EJS_core;
                const controlsJsonPath = `/config/controls_${coreName}.json`; // Path to control JSON file
                // Only fetch global controls if not set by per-game config
                if (typeof window.EJS_defaultControls === 'undefined') {
                  console.log(`Attempting to fetch controls: ${controlsJsonPath}`);
                  try {
                      const controlsResponse = await fetch(controlsJsonPath);
                      if (!controlsResponse.ok) {
                           // Handle file not found gracefully - use defaults
                           if (controlsResponse.status === 404) {
                                console.warn(`Controls file not found: ${controlsJsonPath}. Using EmulatorJS default controls.`);
                                window.EJS_defaultControls = { "0":{}, "1":{}, "2":{}, "3":{} }; // Use default empty controls (valid JSON)
                           } else {
                                // Throw error for other HTTP issues
                                throw new Error(`Failed to fetch controls file (Status: ${controlsResponse.status})`);
                           }
                      } else {
                          // Parse JSON and assign directly
                          const controlsData = await controlsResponse.json();
                          if (!controlsData) throw new Error(`Controls file '${controlsJsonPath}' loaded but contained invalid JSON.`);
                          window.EJS_defaultControls = controlsData; // Assign fetched object
                          console.log(`Controls assigned successfully for core: ${coreName}`);
                      }
                  } catch (controlsError) {
                       // Handle fetch/parse errors specifically for controls JSON
                       console.error(`Error loading or parsing controls from ${controlsJsonPath}:`, controlsError);
                       console.warn("Using EmulatorJS default controls due to controls loading error.");
                       window.EJS_defaultControls = { "0":{}, "1":{}, "2":{}, "3":{} }; // Fallback to default empty controls
                  }
                } else {
                  console.log('Using EJS_defaultControls from per-game config.json');
                }

                // Step 10: Load the main EmulatorJS engine (loader.js)
                // This now happens sequentially after successfully fetching/setting up everything else
                if (window.EJS_pathtodata) {
                    console.log("Loading EmulatorJS engine (loader.js)...");
                    const loaderScript = document.createElement('script');
                    // Use the path defined in emulator_settings.json
                    loaderScript.src = `${window.EJS_pathtodata}loader.js`;
                    loaderScript.onerror = () => {
                        console.error("CRITICAL: Error loading EmulatorJS 'loader.js' from:", loaderScript.src);
                        showLauncherError("Could not load the core emulator engine. Check network connection and EJS_pathtodata setting.");
                    };
                    document.body.appendChild(loaderScript);
                    console.log("EmulatorJS 'loader.js' script added to page.");
                } else {
                     console.error("EJS_pathtodata is not defined after loading settings. Cannot load emulator engine.");
                     showLauncherError("Emulator configuration error: Path to required emulator data is missing.");
                }

            } catch (error) { // Catch errors from initial fetches (gamelist, settings) or setup logic
                console.error("Error during game loading process:", error);
                showLauncherError(error.message || "An unexpected error occurred while preparing the game.");
            }
        }

        // --- Start the loading process once the DOM is ready ---
        // Using DOMContentLoaded ensures the #game-container element exists
        document.addEventListener('DOMContentLoaded', loadSelectedGame);
        
        // Cleanup leaderboard refresh interval when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (window.leaderboardRefreshInterval) {
                clearInterval(window.leaderboardRefreshInterval);
                window.leaderboardRefreshInterval = null;
            }
        });

        // Initialize screensaver mode functionality
        document.addEventListener('DOMContentLoaded', initScreensaverMode);
        
        // Initialize mouse auto-hide functionality
        document.addEventListener('DOMContentLoaded', initMouseAutoHide);

        // Screensaver mode functionality - Completely overhauled for mobile
        function initScreensaverMode() {
            const isScreensaverMode = sessionStorage.getItem('screensaverMode') === 'true';
            
            if (isScreensaverMode) {
                console.log('Screensaver mode activated');
                
                // Set up automatic refresh based on configured interval
                const configuredInterval = parseInt(sessionStorage.getItem('screensaverInterval')) || 150000; // Default to 150 seconds (2.5 minutes)
                console.log('Screensaver mode: Using configured interval of', configuredInterval, 'ms (', Math.round(configuredInterval/1000), 'seconds)');
                const refreshInterval = setInterval(() => {
                    console.log('Screensaver mode: Refreshing to new random game');
                    // Redirect to randomgame to get a new random game
                    window.location.href = '/randomgame/';
                }, configuredInterval);
                
                // Store the interval ID so it can be cleared if needed
                sessionStorage.setItem('screensaverRefreshInterval', refreshInterval);
                
                // Check if mobile device
                const isMobile = 'ontouchstart' in window || window.innerWidth <= 768;
                console.log('Mobile device detected:', isMobile);
                
                if (isMobile) {
                    // Mobile: Create a single timer button in top center with submenu
                    createMobileScreensaverInterface();
                } else {
                    // Desktop: Keep the existing interface
                    createDesktopScreensaverInterface();
                }
                
                // Only allow escape key to exit (no double-tap on mobile)
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        exitScreensaverMode();
                    }
                });
            }
        }
        
        // Create mobile screensaver interface with timer button and submenu
        function createMobileScreensaverInterface() {
            // Create the main timer button - positioned below the game display
            const timerBtn = document.createElement('button');
            timerBtn.id = 'mobile-timer-btn';
            timerBtn.style.cssText = `
                position: fixed;
                bottom: 200px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                padding: 15px 25px;
                border-radius: 30px;
                font-size: 16px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 6px 20px rgba(0,0,0,0.4);
                cursor: pointer;
                transition: all 0.3s ease;
                font-family: sans-serif;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                min-width: 180px;
            `;
            
            // Add hover animation for mobile timer button
            timerBtn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(-50%) scale(1.1)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.6)';
                this.style.background = 'rgba(0, 0, 0, 0.9)';
            });
            
            timerBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(-50%) scale(1)';
                this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
                this.style.background = 'rgba(0, 0, 0, 0.7)';
            });
            timerBtn.textContent = '‚è∞ Screensaver';
            document.body.appendChild(timerBtn);
            
            // Create the submenu container - positioned below the timer button
            const submenu = document.createElement('div');
            submenu.id = 'mobile-screensaver-submenu';
            submenu.style.cssText = `
                position: fixed;
                bottom: 120px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.9);
                border-radius: 15px;
                padding: 15px;
                z-index: 10001;
                display: none;
                flex-direction: column;
                gap: 10px;
                min-width: 200px;
                backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            `;
            
            // Create submenu buttons
            const backToScreensaverBtn = document.createElement('button');
            backToScreensaverBtn.style.cssText = `
                background: rgba(70, 130, 180, 0.9);
                color: white;
                border: none;
                padding: 12px 16px;
                border-radius: 10px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            `;
            backToScreensaverBtn.innerHTML = 'üè† Back to Screensaver';
            backToScreensaverBtn.addEventListener('click', () => {
                exitScreensaverMode(true); // true = redirect to screensaver
            });
            
            const disableScreensaverBtn = document.createElement('button');
            disableScreensaverBtn.style.cssText = `
                background: rgba(220, 53, 69, 0.9);
                color: white;
                border: none;
                padding: 12px 16px;
                border-radius: 10px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            `;
            disableScreensaverBtn.innerHTML = '‚èπÔ∏è Disable Screensaver';
            disableScreensaverBtn.addEventListener('click', () => {
                disableScreensaverMode();
            });
            
            const nextGameBtn = document.createElement('button');
            nextGameBtn.id = 'mobile-next-game-btn';
            nextGameBtn.style.cssText = `
                background: rgba(40, 167, 69, 0.9);
                color: white;
                border: none;
                padding: 12px 16px;
                border-radius: 10px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            `;
            nextGameBtn.innerHTML = '‚è≠Ô∏è Next Game (60s)';
            nextGameBtn.addEventListener('click', () => {
                if (!nextGameBtn.disabled) {
                    console.log('Manual next game requested');
                    window.location.href = '/randomgame/';
                }
            });
            
            // Next Game button is always enabled
            nextGameBtn.innerHTML = '‚è≠Ô∏è Next Game';
            
            // Add buttons to submenu
            submenu.appendChild(backToScreensaverBtn);
            submenu.appendChild(disableScreensaverBtn);
            submenu.appendChild(nextGameBtn);
            document.body.appendChild(submenu);
            
            // Toggle submenu on timer button click
            timerBtn.addEventListener('click', () => {
                const isVisible = submenu.style.display === 'flex';
                submenu.style.display = isVisible ? 'none' : 'flex';
                
                // Add click/touch outside to close functionality
                if (!isVisible) {
                    setTimeout(() => {
                        document.addEventListener('click', closeSubmenu);
                        document.addEventListener('touchstart', closeSubmenu);
                    }, 100);
                }
            });
            
            function closeSubmenu(e) {
                if (!submenu.contains(e.target) && !timerBtn.contains(e.target)) {
                    submenu.style.display = 'none';
                    document.removeEventListener('click', closeSubmenu);
                    document.removeEventListener('touchstart', closeSubmenu);
                }
            }
            
            // Update timer button text every second
            const countdownInterval = setInterval(() => {
                const now = Date.now();
                const startTime = parseInt(sessionStorage.getItem('screensaverStartTime') || '0');
                const elapsed = now - startTime;
                const configuredInterval = parseInt(sessionStorage.getItem('screensaverInterval')) || 150000; // Default to 150 seconds
                const remaining = configuredInterval - elapsed;
                
                // Debug logging (only log every 10 seconds to avoid spam)
                if (Math.floor(remaining / 10000) !== Math.floor((remaining + 1000) / 10000)) {
                    console.log('Screensaver countdown: remaining', Math.round(remaining/1000), 'seconds, configured interval:', Math.round(configuredInterval/1000), 'seconds');
                }
                
                if (remaining <= 0) {
                    timerBtn.textContent = '‚è∞ Refreshing...';
                } else {
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    timerBtn.textContent = `‚è∞ ${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
            
            // Store countdown interval ID
            sessionStorage.setItem('screensaverCountdownInterval', countdownInterval);
        }
        
        // Create desktop screensaver interface with timer button (replacing old buttons)
        function createDesktopScreensaverInterface() {
            // Create the main timer button - positioned above the Menu button
            const timerBtn = document.createElement('button');
            timerBtn.id = 'desktop-timer-btn';
            timerBtn.style.cssText = `
                position: fixed;
                top: 10px;
                left: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                border: none;
                padding: 10px 18px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                cursor: pointer;
                transition: all 0.3s ease;
                font-family: sans-serif;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                min-width: 140px;
            `;
            
            // Add hover animation for desktop timer button
            timerBtn.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.1)';
                this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.5)';
                this.style.background = 'rgba(0, 0, 0, 0.95)';
            });
            
            timerBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                this.style.background = 'rgba(0, 0, 0, 0.8)';
            });
            timerBtn.textContent = '‚è∞ Screensaver';
            document.body.appendChild(timerBtn);
            
            // Create the submenu container - positioned below the timer button
            const submenu = document.createElement('div');
            submenu.id = 'desktop-screensaver-submenu';
            submenu.style.cssText = `
                position: fixed;
                top: 60px;
                left: 10px;
                background: rgba(0, 0, 0, 0.9);
                border-radius: 15px;
                padding: 12px;
                z-index: 10001;
                display: none;
                flex-direction: column;
                gap: 8px;
                min-width: 180px;
                backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            `;
            
            // Create submenu buttons
            const backToScreensaverBtn = document.createElement('button');
            backToScreensaverBtn.style.cssText = `
                background: rgba(70, 130, 180, 0.9);
                color: white;
                border: none;
                padding: 8px 14px;
                border-radius: 8px;
                font-size: 11px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            `;
            backToScreensaverBtn.innerHTML = 'üè† Back to Screensaver';
            backToScreensaverBtn.addEventListener('click', () => {
                exitScreensaverMode(true); // true = redirect to screensaver
            });
            
            const disableScreensaverBtn = document.createElement('button');
            disableScreensaverBtn.style.cssText = `
                background: rgba(220, 53, 69, 0.9);
                color: white;
                border: none;
                padding: 8px 14px;
                border-radius: 8px;
                font-size: 11px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            `;
            disableScreensaverBtn.innerHTML = '‚èπÔ∏è Disable Screensaver';
            disableScreensaverBtn.addEventListener('click', () => {
                disableScreensaverMode();
            });
            
            const nextGameBtn = document.createElement('button');
            nextGameBtn.id = 'desktop-next-game-btn';
            nextGameBtn.style.cssText = `
                background: rgba(40, 167, 69, 0.9);
                color: white;
                border: none;
                padding: 8px 14px;
                border-radius: 8px;
                font-size: 11px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s ease;
                font-family: sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            `;
            nextGameBtn.innerHTML = '‚è≠Ô∏è Next Game';
            nextGameBtn.addEventListener('click', () => {
                console.log('Manual next game requested');
                window.location.href = '/randomgame/';
            });
            
            // Add buttons to submenu
            submenu.appendChild(backToScreensaverBtn);
            submenu.appendChild(disableScreensaverBtn);
            submenu.appendChild(nextGameBtn);
            document.body.appendChild(submenu);
            
            // Toggle submenu on timer button click
            timerBtn.addEventListener('click', () => {
                const isVisible = submenu.style.display === 'flex';
                submenu.style.display = isVisible ? 'none' : 'flex';
                
                // Add click/touch outside to close functionality
                if (!isVisible) {
                    setTimeout(() => {
                        document.addEventListener('click', closeSubmenu);
                        document.addEventListener('touchstart', closeSubmenu);
                    }, 100);
                }
            });
            
            function closeSubmenu(e) {
                if (!submenu.contains(e.target) && !timerBtn.contains(e.target)) {
                    submenu.style.display = 'none';
                    document.removeEventListener('click', closeSubmenu);
                    document.removeEventListener('touchstart', closeSubmenu);
                }
            }
            
            // Update timer button text every second
            const countdownInterval = setInterval(() => {
                const now = Date.now();
                const startTime = parseInt(sessionStorage.getItem('screensaverStartTime') || '0');
                const elapsed = now - startTime;
                const configuredInterval = parseInt(sessionStorage.getItem('screensaverInterval')) || 150000; // Default to 150 seconds
                const remaining = configuredInterval - elapsed;
                
                // Debug logging (only log every 10 seconds to avoid spam)
                if (Math.floor(remaining / 10000) !== Math.floor((remaining + 1000) / 10000)) {
                    console.log('Screensaver countdown: remaining', Math.round(remaining/1000), 'seconds, configured interval:', Math.round(configuredInterval/1000), 'seconds');
                }
                
                if (remaining <= 0) {
                    timerBtn.textContent = '‚è∞ Refreshing...';
                } else {
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    timerBtn.textContent = `‚è∞ ${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
            
            // Store countdown interval ID
            sessionStorage.setItem('screensaverCountdownInterval', countdownInterval);
        }
        
        // Function to disable screensaver mode
        function disableScreensaverMode() {
            // Clear all intervals
            const refreshInterval = sessionStorage.getItem('screensaverRefreshInterval');
            const countdownInterval = sessionStorage.getItem('screensaverCountdownInterval');
            
            if (refreshInterval) clearInterval(parseInt(refreshInterval));
            if (countdownInterval) clearInterval(parseInt(countdownInterval));
            
            // Clear leaderboard refresh interval if it exists
            if (window.leaderboardRefreshInterval) {
                clearInterval(window.leaderboardRefreshInterval);
                window.leaderboardRefreshInterval = null;
            }
            
            // Clear screensaver mode
            sessionStorage.removeItem('screensaverMode');
            sessionStorage.removeItem('screensaverRefreshInterval');
            sessionStorage.removeItem('screensaverCountdownInterval');
            sessionStorage.removeItem('screensaverStartTime');
            
            // Remove all visual indicators
            const elementsToRemove = [
                'screensaver-indicator',
                'screensaver-countdown',
                'disable-screensaver-btn',
                'desktop-next-game-btn',
                'mobile-timer-btn',
                'mobile-screensaver-submenu',
                'desktop-timer-btn',
                'desktop-screensaver-submenu'
            ];
            
            elementsToRemove.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.remove();
            });
            
            console.log('Screensaver mode disabled - continuing with current game');
            
            // Show confirmation
            const confirmation = document.createElement('div');
            confirmation.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 20px;
                border-radius: 10px;
                font-size: 16px;
                z-index: 10001;
                text-align: center;
                backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            confirmation.innerHTML = 'Screensaver mode disabled<br><small>You can continue playing this game</small>';
            document.body.appendChild(confirmation);
            
            // Remove confirmation after 3 seconds
            setTimeout(() => {
                confirmation.remove();
            }, 3000);
        }
        
        function exitScreensaverMode(redirectToScreensaver = false) {
            // Clear all intervals
            const refreshInterval = sessionStorage.getItem('screensaverRefreshInterval');
            const countdownInterval = sessionStorage.getItem('screensaverCountdownInterval');
            
            if (refreshInterval) clearInterval(parseInt(refreshInterval));
            if (countdownInterval) clearInterval(parseInt(countdownInterval));
            
            // Clear leaderboard refresh interval if it exists
            if (window.leaderboardRefreshInterval) {
                clearInterval(window.leaderboardRefreshInterval);
                window.leaderboardRefreshInterval = null;
            }
            
            // Remove all visual indicators (both mobile and desktop)
            const elementsToRemove = [
                'screensaver-indicator',
                'screensaver-countdown',
                'disable-screensaver-btn',
                'desktop-next-game-btn',
                'mobile-timer-btn',
                'mobile-screensaver-submenu',
                'desktop-timer-btn',
                'desktop-screensaver-submenu'
            ];
            
            elementsToRemove.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.remove();
            });
            
            // Clear screensaver mode
            sessionStorage.removeItem('screensaverMode');
            sessionStorage.removeItem('screensaverRefreshInterval');
            sessionStorage.removeItem('screensaverCountdownInterval');
            sessionStorage.removeItem('screensaverStartTime');
            
            console.log('Screensaver mode deactivated');
            
            // If redirecting to screensaver, do it immediately
            if (redirectToScreensaver) {
                window.location.href = '/screensaver/';
                return;
            }
            
            // Show confirmation
            const confirmation = document.createElement('div');
            confirmation.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 20px;
                border-radius: 10px;
                font-size: 16px;
                z-index: 10001;
                text-align: center;
                backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            confirmation.innerHTML = 'Screensaver mode deactivated<br><small>Press any key or tap to continue</small>';
            document.body.appendChild(confirmation);
            
            // Remove confirmation after 3 seconds or on interaction
            const removeConfirmation = () => {
                confirmation.remove();
                document.removeEventListener('keydown', removeConfirmation);
                document.removeEventListener('touchend', removeConfirmation);
            };
            
            setTimeout(removeConfirmation, 3000);
            document.addEventListener('keydown', removeConfirmation);
            document.addEventListener('touchend', removeConfirmation);
        }
        
        // Menu button referrer logic
        document.getElementById('menu-button').addEventListener('click', function() {
            if (sessionStorage.getItem('referrerAllGames') === '1') {
                sessionStorage.removeItem('referrerAllGames');
                window.location.href = '/all/';
            } else {
                window.location.href = '/';
            }
        });
        
        // Help button functionality
        document.getElementById('help-button').addEventListener('click', function() {
            const helpModal = document.getElementById('help-modal');
            const helpModalContent = document.getElementById('help-modal-content');
            if (helpModal && helpModalContent) {
                helpModal.style.display = 'flex';
                helpModalContent.scrollTop = 0; // Scroll to top when opening
            }
        });

        // Close help modal functionality
        document.getElementById('help-modal-close').addEventListener('click', function() {
            const helpModal = document.getElementById('help-modal');
            if (helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // Click outside help modal to close
        document.getElementById('help-modal').addEventListener('click', function(e) {
            if (!this.contains(e.target) && e.target !== document.getElementById('help-modal-close')) {
                this.style.display = 'none';
            }
        });
        
        // Mobile leaderboard popup event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const mobilePopup = document.getElementById('mobile-leaderboard-popup');
            const mobileCloseBtn = document.getElementById('mobile-leaderboard-close');
            
            if (mobilePopup && mobileCloseBtn) {
                // Close button click
                mobileCloseBtn.addEventListener('click', function() {
                    mobilePopup.style.display = 'none';
                });
                
                // Click anywhere on popup to close
                mobilePopup.addEventListener('click', function(e) {
                    mobilePopup.style.display = 'none';
                });
                
                // Prevent closing when clicking on the content box itself
                const mobileContent = document.getElementById('mobile-leaderboard-content');
                if (mobileContent) {
                    mobileContent.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }
            }
        });
        
        // Mouse auto-hide functionality
        function initMouseAutoHide() {
            let mouseTimeout;
            const MOUSE_HIDE_DELAY = 5000; // 5 seconds
            
            // Function to show mouse cursor
            function showMouse() {
                document.body.classList.remove('mouse-hidden');
            }
            
            // Function to hide mouse cursor
            function hideMouse() {
                document.body.classList.add('mouse-hidden');
            }
            
            // Function to reset the timeout
            function resetMouseTimeout() {
                showMouse();
                clearTimeout(mouseTimeout);
                mouseTimeout = setTimeout(hideMouse, MOUSE_HIDE_DELAY);
            }
            
            // Track mouse movement
            document.addEventListener('mousemove', resetMouseTimeout);
            document.addEventListener('mousedown', resetMouseTimeout);
            document.addEventListener('mouseup', resetMouseTimeout);
            
            // Track touch events (for mobile devices)
            document.addEventListener('touchstart', resetMouseTimeout);
            document.addEventListener('touchend', resetMouseTimeout);
            
            // Track keyboard events
            document.addEventListener('keydown', resetMouseTimeout);
            document.addEventListener('keyup', resetMouseTimeout);
            
            // Start the initial timeout
            resetMouseTimeout();
            
            console.log('Mouse auto-hide initialized with 5-second timeout');
        }
    </script>
</body>
</html>
